<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ·±åº¦æ•¸æ“šæ¸…æ´—å·¥å…· - AIå¢å¼·ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Microsoft JhengHei', 'Arial', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
        }

        .header p {
            font-size: 1.1em;
            opacity: 0.9;
        }

        .mode-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            margin-top: 10px;
            font-weight: bold;
        }

        .mode-local {
            background: #28a745;
        }

        .mode-ai {
            background: #ff6b6b;
        }

        .content {
            padding: 30px;
        }

        .section {
            margin-bottom: 30px;
            padding: 25px;
            background: #f8f9fa;
            border-radius: 15px;
            border-left: 5px solid #667eea;
        }

        .section h2 {
            color: #667eea;
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .mode-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .mode-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            border: 3px solid #e0e0e0;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }

        .mode-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }

        .mode-card.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #f0f4ff 0%, #e8f0ff 100%);
        }

        .mode-card h3 {
            font-size: 1.3em;
            margin-bottom: 10px;
            color: #667eea;
        }

        .mode-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .mode-features {
            list-style: none;
            margin-top: 15px;
        }

        .mode-features li {
            padding: 5px 0;
            color: #666;
        }

        .mode-features li:before {
            content: "âœ“ ";
            color: #28a745;
            font-weight: bold;
            margin-right: 5px;
        }

        .api-config {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            display: none;
        }

        .api-config.show {
            display: block;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
        }

        .input-group small {
            color: #666;
            display: block;
            margin-top: 5px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 40px;
            text-align: center;
            background: white;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            background: #f0f4ff;
            border-color: #764ba2;
        }

        .upload-area.dragover {
            background: #e8f0ff;
            border-color: #764ba2;
            transform: scale(1.02);
        }

        .file-input {
            display: none;
        }

        .upload-icon {
            font-size: 4em;
            color: #667eea;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 30px;
            border: none;
            border-radius: 25px;
            font-size: 1em;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: bold;
            margin: 5px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
            color: white;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .options-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .option-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #e0e0e0;
            transition: all 0.3s;
        }

        .option-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            cursor: pointer;
            font-size: 1em;
        }

        .checkbox-label input {
            margin-right: 10px;
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6c757d;
            font-size: 0.9em;
        }

        .preview-table {
            width: 100%;
            overflow-x: auto;
            margin-top: 20px;
            background: white;
            border-radius: 10px;
            padding: 15px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #e0e0e0;
            font-size: 0.9em;
        }

        th {
            background: #667eea;
            color: white;
            font-weight: bold;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            overflow: hidden;
            margin-top: 15px;
            display: none;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }

        .log {
            background: #2d3748;
            color: #a0aec0;
            padding: 15px;
            border-radius: 10px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
            margin-top: 15px;
            display: none;
        }

        .log-entry {
            margin-bottom: 5px;
            padding: 3px 0;
        }

        .log-entry.success {
            color: #48bb78;
        }

        .log-entry.warning {
            color: #ed8936;
        }

        .log-entry.info {
            color: #4299e1;
        }

        .log-entry.ai {
            color: #9f7aea;
        }

        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }

        .alert {
            padding: 15px 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border-left: 5px solid #17a2b8;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border-left: 5px solid #ffc107;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border-left: 5px solid #28a745;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border-left: 5px solid #dc3545;
        }

        .example-box {
            background: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 15px;
            border-left: 4px solid #28a745;
        }

        .example-box h4 {
            color: #28a745;
            margin-bottom: 10px;
        }

        .example-item {
            margin: 8px 0;
            padding: 8px;
            background: #f8f9fa;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .example-item strong {
            color: #667eea;
        }

        .comparison-table {
            width: 100%;
            margin-top: 15px;
        }

        .comparison-table td {
            padding: 10px;
            border: 1px solid #e0e0e0;
        }

        .comparison-table .header-cell {
            background: #f8f9fa;
            font-weight: bold;
            color: #667eea;
        }

        .badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 5px;
        }

        .badge-pro {
            background: #ffd700;
            color: #333;
        }

        .badge-free {
            background: #28a745;
            color: white;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ§¹ æ·±åº¦æ•¸æ“šæ¸…æ´—å·¥å…· - AIå¢å¼·ç‰ˆ</h1>
            <p>æ”¯æ´æœ¬æ©Ÿé›¢ç·šæ¨¡å¼ + Claude AIæ™ºèƒ½é©—è­‰æ¨¡å¼</p>
            <div class="mode-badge mode-local" id="modeBadge">æœ¬æ©Ÿæ¨¡å¼</div>
        </div>

        <div class="content">
            <!-- æ¨¡å¼é¸æ“‡ -->
            <div class="section">
                <h2>ğŸ¯ æ­¥é©Ÿ 0: é¸æ“‡è™•ç†æ¨¡å¼</h2>
                
                <div class="alert alert-info">
                    <strong>ğŸ’¡ æç¤º:</strong> æœ¬æ©Ÿæ¨¡å¼å®Œå…¨é›¢ç·šå…è²»ä½¿ç”¨,AIæ¨¡å¼éœ€è¦Anthropic API Keyä½†æä¾›æ›´ç²¾æº–çš„çµæœ
                </div>

                <div class="mode-selector">
                    <div class="mode-card selected" id="modeLocal" data-mode="local">
                        <div class="mode-icon">ğŸ’»</div>
                        <h3>æœ¬æ©Ÿè¦å‰‡æ¨¡å¼ <span class="badge badge-free">å…è²»</span></h3>
                        <p>ä½¿ç”¨æ­£å‰‡è¡¨é”å¼è¦å‰‡é€²è¡Œæ•¸æ“šæ¸…æ´—</p>
                        <ul class="mode-features">
                            <li>å®Œå…¨é›¢ç·šé‹è¡Œ</li>
                            <li>å¿«é€Ÿè™•ç†å¤§é‡æ•¸æ“š</li>
                            <li>ç„¡éœ€API key</li>
                            <li>é©åˆæ¨™æº–æ ¼å¼æ•¸æ“š</li>
                        </ul>
                    </div>

                    <div class="mode-card" id="modeAI" data-mode="ai">
                        <div class="mode-icon">ğŸ¤–</div>
                        <h3>AIå¢å¼·æ¨¡å¼ <span class="badge badge-pro">éœ€è¦API</span></h3>
                        <p>ä½¿ç”¨Claude AIé€²è¡Œæ™ºèƒ½é©—è­‰å’Œä¿®æ­£</p>
                        <ul class="mode-features">
                            <li>AIå¤šé‡é©—è­‰æ¼æ–—</li>
                            <li>æ™ºèƒ½è­˜åˆ¥é‚Šç·£æ¡ˆä¾‹</li>
                            <li>è‡ªå‹•ä¿®æ­£éŒ¯èª¤æ‹†åˆ†</li>
                            <li>é©åˆè¤‡é›œä¸è¦å‰‡æ•¸æ“š</li>
                        </ul>
                    </div>
                </div>

                <div class="api-config" id="apiConfig">
                    <h3 style="color: #667eea; margin-bottom: 15px;">ğŸ”‘ API é…ç½®</h3>
                    <div class="alert alert-warning">
                        <strong>âš ï¸ æ³¨æ„:</strong> APIèª¿ç”¨æœƒç”¢ç”Ÿè²»ç”¨ã€‚å»ºè­°å…ˆç”¨æœ¬æ©Ÿæ¨¡å¼æ¸¬è©¦,ç¢ºèªéœ€è¦AIå¢å¼·å¾Œå†ä½¿ç”¨æ­¤æ¨¡å¼ã€‚
                    </div>
                    <div class="input-group">
                        <label for="apiKey">Anthropic API Key:</label>
                        <input type="password" id="apiKey" placeholder="sk-ant-api03-...">
                        <small>æ‚¨çš„API keyæœƒä¿å­˜åœ¨æœ¬åœ°ç€è¦½å™¨,ä¸æœƒä¸Šå‚³åˆ°ä»»ä½•æœå‹™å™¨ã€‚<a href="https://console.anthropic.com/" target="_blank">ç²å–API Key</a></small>
                    </div>
                    <div class="input-group">
                        <label for="batchSize">æ‰¹æ¬¡è™•ç†æ•¸é‡ (æ¯æ‰¹):</label>
                        <input type="number" id="batchSize" value="10" min="1" max="50">
                        <small>æ¯æ¬¡APIèª¿ç”¨è™•ç†çš„è¡Œæ•¸ã€‚å»ºè­°10-20è¡Œ,å¹³è¡¡é€Ÿåº¦å’Œæˆæœ¬ã€‚</small>
                    </div>
                </div>
            </div>

            <!-- æ–‡ä»¶ä¸Šå‚³å€ -->
            <div class="section">
                <h2>ğŸ“ æ­¥é©Ÿ 1: ä¸Šå‚³CSVæ–‡ä»¶</h2>
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">ğŸ“¤</div>
                    <h3>é»æ“Šæˆ–æ‹–æ”¾CSVæ–‡ä»¶åˆ°æ­¤è™•</h3>
                    <p style="color: #6c757d; margin-top: 10px;">æ”¯æŒå¤§å‹CSVæ–‡ä»¶</p>
                    <input type="file" id="fileInput" class="file-input" accept=".csv">
                </div>
                <div id="fileInfo" style="margin-top: 15px; display: none;">
                    <div class="alert alert-success">
                        <strong>âœ“ æ–‡ä»¶å·²è¼‰å…¥:</strong> <span id="fileName"></span> 
                        (<span id="fileSize"></span>)
                    </div>
                </div>
            </div>

            <!-- æ¸…æ´—é¸é … -->
            <div class="section" id="optionsSection" style="display: none;">
                <h2>âš™ï¸ æ­¥é©Ÿ 2: é¸æ“‡æ¸…æ´—é¸é …</h2>
                
                <div class="example-box">
                    <h4>ğŸ“Œ ç”¢å“åç¨±æ‹†åˆ†ç¤ºä¾‹</h4>
                    <div class="example-item">
                        <strong>åŸå§‹:</strong> ç¹ªåœ–ç­† 0.3æ¯«ç±³ [é»‘è‰²]<br>
                        <strong>åŸºç¤åç¨±:</strong> ç¹ªåœ–ç­†<br>
                        <strong>å±¬æ€§è®Šé‡:</strong> 0.3æ¯«ç±³ [é»‘è‰²]
                    </div>
                </div>

                <div class="options-grid">
                    <div class="option-card">
                        <label class="checkbox-label">
                            <input type="checkbox" id="removeDuplicates" checked>
                            <span><strong>å»é™¤é‡è¤‡æ•¸æ“š</strong><br><small>æ ¹æ“šItem No.å»é‡</small></span>
                        </label>
                    </div>
                    <div class="option-card">
                        <label class="checkbox-label">
                            <input type="checkbox" id="handleEmpty" checked>
                            <span><strong>è™•ç†ç©ºç™½æ¬„ä½</strong><br><small>æ¨™è¨˜ç©ºå€¼</small></span>
                        </label>
                    </div>
                    <div class="option-card">
                        <label class="checkbox-label">
                            <input type="checkbox" id="extractColor" checked>
                            <span><strong>æå–é¡è‰²å±¬æ€§</strong><br><small>å¾[æ–¹æ‹¬è™Ÿ]æå–</small></span>
                        </label>
                    </div>
                    <div class="option-card">
                        <label class="checkbox-label">
                            <input type="checkbox" id="extractSize" checked>
                            <span><strong>æå–å°ºå¯¸è¦æ ¼</strong><br><small>æå–æ¯«ç±³/å‹/å˜ç±³</small></span>
                        </label>
                    </div>
                    <div class="option-card">
                        <label class="checkbox-label">
                            <input type="checkbox" id="extractQuantity" checked>
                            <span><strong>æå–æ•¸é‡åŒ…è£</strong><br><small>æå–æšè£/å€‹è£</small></span>
                        </label>
                    </div>
                    <div class="option-card">
                        <label class="checkbox-label">
                            <input type="checkbox" id="splitNames" checked>
                            <span><strong>æ‹†åˆ†ç”¢å“åç¨±</strong><br><small>åŸºç¤åç¨±èˆ‡å±¬æ€§åˆ†é›¢</small></span>
                        </label>
                    </div>
                </div>

                <div class="button-group">
                    <button class="btn btn-primary" id="startClean">
                        ğŸš€ é–‹å§‹æ¸…æ´—æ•¸æ“š
                    </button>
                    <button class="btn btn-secondary" id="resetOptions">
                        ğŸ”„ é‡ç½®é¸é …
                    </button>
                </div>

                <div class="progress-bar" id="progressBar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>

                <div class="log" id="logConsole"></div>
            </div>

            <!-- çµ±è¨ˆä¿¡æ¯ -->
            <div class="section" id="statsSection" style="display: none;">
                <h2>ğŸ“Š æ­¥é©Ÿ 3: æŸ¥çœ‹çµ±è¨ˆçµæœ</h2>
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value" id="totalRows">0</div>
                        <div class="stat-label">ç¸½è¡Œæ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="cleanedRows">0</div>
                        <div class="stat-label">æ¸…æ´—å¾Œè¡Œæ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="duplicateCount">0</div>
                        <div class="stat-label">é‡è¤‡æ•¸æ“š</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="aiVerified">0</div>
                        <div class="stat-label" id="aiVerifiedLabel">AIé©—è­‰æ•¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="colorExtracted">0</div>
                        <div class="stat-label">é¡è‰²æå–</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="sizeExtracted">0</div>
                        <div class="stat-label">å°ºå¯¸æå–</div>
                    </div>
                </div>
            </div>

            <!-- é è¦½èˆ‡ä¸‹è¼‰ -->
            <div class="section" id="previewSection" style="display: none;">
                <h2>ğŸ‘€ æ­¥é©Ÿ 4: é è¦½èˆ‡ä¸‹è¼‰</h2>
                <div class="alert alert-info">
                    <strong>æç¤º:</strong> ä»¥ä¸‹é¡¯ç¤ºå‰50è¡Œæ¸…æ´—å¾Œçš„æ•¸æ“šé è¦½
                </div>
                <div class="preview-table">
                    <div style="overflow-x: auto; max-height: 400px;">
                        <table id="previewTable">
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn btn-success" id="downloadBtn">
                        ğŸ’¾ ä¸‹è¼‰æ¸…æ´—å¾Œçš„CSV
                    </button>
                    <button class="btn btn-secondary" id="newFileBtn">
                        ğŸ“„ è¼‰å…¥æ–°æ–‡ä»¶
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <script>
        // å…¨å±€è®Šæ•¸
        let originalData = [];
        let cleanedData = [];
        let headers = [];
        let currentMode = 'local';
        let apiKey = localStorage.getItem('anthropic_api_key') || '';

        // DOM å…ƒç´ 
        const modeLocal = document.getElementById('modeLocal');
        const modeAI = document.getElementById('modeAI');
        const apiConfig = document.getElementById('apiConfig');
        const apiKeyInput = document.getElementById('apiKey');
        const batchSizeInput = document.getElementById('batchSize');
        const modeBadge = document.getElementById('modeBadge');
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileInfo = document.getElementById('fileInfo');
        const fileName = document.getElementById('fileName');
        const fileSize = document.getElementById('fileSize');
        const optionsSection = document.getElementById('optionsSection');
        const statsSection = document.getElementById('statsSection');
        const previewSection = document.getElementById('previewSection');
        const startCleanBtn = document.getElementById('startClean');
        const resetOptionsBtn = document.getElementById('resetOptions');
        const downloadBtn = document.getElementById('downloadBtn');
        const newFileBtn = document.getElementById('newFileBtn');
        const progressBar = document.getElementById('progressBar');
        const progressFill = document.getElementById('progressFill');
        const logConsole = document.getElementById('logConsole');

        // è¼‰å…¥ä¿å­˜çš„API key
        if (apiKey) {
            apiKeyInput.value = apiKey;
        }

        // æ¨¡å¼åˆ‡æ›
        modeLocal.addEventListener('click', () => {
            currentMode = 'local';
            modeLocal.classList.add('selected');
            modeAI.classList.remove('selected');
            apiConfig.classList.remove('show');
            modeBadge.textContent = 'æœ¬æ©Ÿæ¨¡å¼';
            modeBadge.className = 'mode-badge mode-local';
            document.getElementById('aiVerifiedLabel').textContent = 'è™•ç†è¡Œæ•¸';
        });

        modeAI.addEventListener('click', () => {
            currentMode = 'ai';
            modeAI.classList.add('selected');
            modeLocal.classList.remove('selected');
            apiConfig.classList.add('show');
            modeBadge.textContent = 'AIå¢å¼·æ¨¡å¼';
            modeBadge.className = 'mode-badge mode-ai';
            document.getElementById('aiVerifiedLabel').textContent = 'AIé©—è­‰æ•¸';
        });

        // ä¿å­˜API key
        apiKeyInput.addEventListener('change', () => {
            apiKey = apiKeyInput.value;
            localStorage.setItem('anthropic_api_key', apiKey);
        });

        // æ–‡ä»¶ä¸Šå‚³è™•ç†
        uploadArea.addEventListener('click', () => fileInput.click());
        
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                handleFile(files[0]);
            }
        });

        fileInput.addEventListener('change', (e) => {
            if (e.target.files.length > 0) {
                handleFile(e.target.files[0]);
            }
        });

        // é‡ç½®é¸é …
        resetOptionsBtn.addEventListener('click', () => {
            document.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = true);
            addLog('é¸é …å·²é‡ç½®ç‚ºé»˜èªå€¼', 'info');
        });

        // è¼‰å…¥æ–°æ–‡ä»¶
        newFileBtn.addEventListener('click', () => {
            location.reload();
        });

        // è™•ç†æ–‡ä»¶
        function handleFile(file) {
            if (!file.name.endsWith('.csv')) {
                alert('è«‹ä¸Šå‚³CSVæ–‡ä»¶!');
                return;
            }

            fileName.textContent = file.name;
            fileSize.textContent = formatFileSize(file.size);
            fileInfo.style.display = 'block';
            
            addLog('é–‹å§‹è®€å–æ–‡ä»¶...', 'info');
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                encoding: 'UTF-8',
                complete: function(results) {
                    originalData = results.data;
                    headers = results.meta.fields;
                    addLog(`âœ“ æ–‡ä»¶è®€å–å®Œæˆ! å…± ${originalData.length} è¡Œæ•¸æ“š`, 'success');
                    optionsSection.style.display = 'block';
                    optionsSection.scrollIntoView({ behavior: 'smooth' });
                },
                error: function(error) {
                    addLog(`âœ— éŒ¯èª¤: ${error.message}`, 'warning');
                    alert('æ–‡ä»¶è®€å–å¤±æ•—,è«‹æª¢æŸ¥æ–‡ä»¶æ ¼å¼!');
                }
            });
        }

        // æ ¼å¼åŒ–æ–‡ä»¶å¤§å°
        function formatFileSize(bytes) {
            if (bytes < 1024) return bytes + ' B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(2) + ' KB';
            return (bytes / (1024 * 1024)).toFixed(2) + ' MB';
        }

        // æ·»åŠ æ—¥èªŒ
        function addLog(message, type = 'info') {
            logConsole.style.display = 'block';
            const entry = document.createElement('div');
            entry.className = `log-entry ${type}`;
            const time = new Date().toLocaleTimeString();
            entry.textContent = `[${time}] ${message}`;
            logConsole.appendChild(entry);
            logConsole.scrollTop = logConsole.scrollHeight;
        }

        // æ›´æ–°é€²åº¦æ¢
        function updateProgress(percent) {
            progressBar.style.display = 'block';
            progressFill.style.width = percent + '%';
            progressFill.textContent = Math.round(percent) + '%';
        }

        // æœ¬æ©Ÿæ¨¡å¼: æå–ç´”ç”¢å“åç¨± (ä¸­æ–‡)
        function extractChineseBaseName(name) {
            if (!name) return '';
            
            let baseName = name;
            baseName = baseName.replace(/\[([^\]]+)\]/g, '');
            baseName = baseName.replace(/\d+\s*(æšè£|å€‹è£|ä»¶è£|æ”¯è£|æ¢è£|å·è£|æœ¬è£|å¼µè£|ç²’è£|é |s\b)/gi, '');
            baseName = baseName.replace(/\d+\.?\d*\s*x\s*\d+\.?\d*\s*(æ¯«ç±³|å˜ç±³|å‹|å°º|mm|cm|in|ft|m)/gi, '');
            baseName = baseName.replace(/\d+\.?\d*\s*(æ¯«ç±³|å˜ç±³|å‹|å°º|mm|cm|in|ft|m|å…‹|g|ml|æ¯«å‡|å‡|l)\b/gi, '');
            baseName = baseName.replace(/\b[A-Z]?\d+[A-Z]?\b/g, '');
            baseName = baseName.replace(/\b\d+\.?\d*[A-Z]?\b/g, '');
            baseName = baseName.replace(/\s+é€£\s+.*/g, '');
            baseName = baseName.replace(/\s+/g, ' ').trim();
            
            return baseName;
        }

        // æœ¬æ©Ÿæ¨¡å¼: æå–ç´”ç”¢å“åç¨± (è‹±æ–‡)
        function extractEnglishBaseName(name) {
            if (!name) return '';
            
            let baseName = name;
            baseName = baseName.replace(/\[([^\]]+)\]/g, '');
            baseName = baseName.replace(/\d+\s*s\b/gi, '');
            baseName = baseName.replace(/\d+\.?\d*\s*x\s*\d+\.?\d*\s*(mm|cm|in|ft|m)/gi, '');
            baseName = baseName.replace(/\d+\.?\d*\s*(mm|cm|in|ft|m|g|ml|l)\b/gi, '');
            baseName = baseName.replace(/\b[A-Z]?\d+[A-Z]?\b/g, '');
            baseName = baseName.replace(/\b\d+\.?\d*[A-Z]?\b/g, '');
            baseName = baseName.replace(/\s+with\s+.*/gi, '');
            baseName = baseName.replace(/\s+w\/\s+.*/gi, '');
            baseName = baseName.replace(/\s+/g, ' ').trim();
            
            return baseName;
        }

        // æå–å±¬æ€§è®Šé‡
        function extractAttributes(originalName, baseName) {
            if (!originalName || !baseName) return '';
            let attributes = originalName.replace(baseName, '').trim();
            attributes = attributes.replace(/\s+/g, ' ').trim();
            return attributes;
        }

        // AIæ¨¡å¼: èª¿ç”¨Claude APIé€²è¡Œæ™ºèƒ½é©—è­‰
        async function aiVerifyAndCorrect(batch) {
            const prompt = `ä½ æ˜¯ä¸€å€‹å°ˆæ¥­çš„ç”¢å“æ•¸æ“šæ¸…æ´—å°ˆå®¶ã€‚æˆ‘éœ€è¦ä½ å¹«æˆ‘é©—è­‰å’Œä¿®æ­£ç”¢å“åç¨±çš„æ‹†åˆ†çµæœã€‚

ä»»å‹™èªªæ˜:
1. æˆ‘æœƒçµ¦ä½ ä¸€æ‰¹ç”¢å“æ•¸æ“š,æ¯å€‹ç”¢å“åŒ…å«åŸå§‹åç¨±ã€å·²æ‹†åˆ†çš„åŸºç¤åç¨±å’Œå±¬æ€§
2. è«‹æª¢æŸ¥æ‹†åˆ†æ˜¯å¦æ­£ç¢º
3. åŸºç¤åç¨±æ‡‰è©²æ˜¯ç´”ç”¢å“åç¨±,ä¸åŒ…å«ä»»ä½•è¦æ ¼ã€å°ºå¯¸ã€æ•¸é‡ã€é¡è‰²ç­‰
4. å¦‚æœæ‹†åˆ†æœ‰èª¤,è«‹ä¿®æ­£ä¸¦è¿”å›æ­£ç¢ºçµæœ

æ•¸æ“šæ ¼å¼:
${JSON.stringify(batch.map((item, idx) => ({
    index: idx,
    chinese_original: item.chinese_original,
    chinese_base: item.chinese_base,
    chinese_attrs: item.chinese_attrs,
    english_original: item.english_original,
    english_base: item.english_base,
    english_attrs: item.english_attrs
})), null, 2)}

è«‹ä»¥JSONæ ¼å¼è¿”å›ä¿®æ­£å¾Œçš„çµæœ,æ ¼å¼å¦‚ä¸‹:
[
  {
    "index": 0,
    "chinese_base": "ä¿®æ­£å¾Œçš„ä¸­æ–‡åŸºç¤åç¨±",
    "chinese_attrs": "ä¿®æ­£å¾Œçš„ä¸­æ–‡å±¬æ€§",
    "english_base": "Modified English Base Name",
    "english_attrs": "Modified English Attributes",
    "corrected": true/false (æ˜¯å¦é€²è¡Œäº†ä¿®æ­£)
  },
  ...
]

åªè¿”å›JSON,ä¸è¦å…¶ä»–èªªæ˜ã€‚`;

            try {
                const response = await fetch('https://api.anthropic.com/v1/messages', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-api-key': apiKey,
                        'anthropic-version': '2023-06-01'
                    },
                    body: JSON.stringify({
                        model: 'claude-sonnet-4-20250514',
                        max_tokens: 4000,
                        messages: [{
                            role: 'user',
                            content: prompt
                        }]
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const responseText = data.content[0].text;
                
                // æ¸…ç†å¯èƒ½çš„markdownæ¨™è¨˜
                const cleanedText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
                const results = JSON.parse(cleanedText);
                
                return results;
            } catch (error) {
                addLog(`AIé©—è­‰éŒ¯èª¤: ${error.message}`, 'warning');
                return null;
            }
        }

        // é–‹å§‹æ¸…æ´—æ•¸æ“š
        startCleanBtn.addEventListener('click', async () => {
            // é©—è­‰AIæ¨¡å¼é…ç½®
            if (currentMode === 'ai') {
                if (!apiKey || apiKey.trim() === '') {
                    alert('è«‹å…ˆè¼¸å…¥Anthropic API Key!');
                    return;
                }
            }

            startCleanBtn.disabled = true;
            startCleanBtn.innerHTML = '<span class="loading"></span>è™•ç†ä¸­...';
            
            logConsole.innerHTML = '';
            addLog(`ğŸš€ é–‹å§‹æ•¸æ“šæ¸…æ´—æµç¨‹ [${currentMode === 'local' ? 'æœ¬æ©Ÿæ¨¡å¼' : 'AIå¢å¼·æ¨¡å¼'}]`, 'info');
            updateProgress(0);

            cleanedData = JSON.parse(JSON.stringify(originalData));
            let stats = {
                total: originalData.length,
                duplicates: 0,
                empty: 0,
                colorExtracted: 0,
                sizeExtracted: 0,
                quantityExtracted: 0,
                namesSplit: 0,
                aiVerified: 0,
                aiCorrected: 0
            };

            // 1. å»é™¤é‡è¤‡
            if (document.getElementById('removeDuplicates').checked) {
                addLog('â³ åŸ·è¡Œ: å»é™¤é‡è¤‡æ•¸æ“š...', 'info');
                const originalCount = cleanedData.length;
                const seen = new Set();
                cleanedData = cleanedData.filter(row => {
                    const key = (row['Item No.'] || '').trim();
                    if (seen.has(key) && key !== '') return false;
                    seen.add(key);
                    return true;
                });
                stats.duplicates = originalCount - cleanedData.length;
                addLog(`âœ“ ç§»é™¤äº† ${stats.duplicates} æ¢é‡è¤‡æ•¸æ“š`, 'success');
                updateProgress(10);
            }

            // 2. è™•ç†ç©ºç™½æ¬„ä½
            if (document.getElementById('handleEmpty').checked) {
                addLog('â³ åŸ·è¡Œ: è™•ç†ç©ºç™½æ¬„ä½...', 'info');
                cleanedData.forEach(row => {
                    Object.keys(row).forEach(key => {
                        if (!row[key] || row[key].trim() === '') {
                            row[key] = '[ç©ºç™½]';
                            stats.empty++;
                        }
                    });
                });
                addLog(`âœ“ æ¨™è¨˜äº† ${stats.empty} å€‹ç©ºç™½æ¬„ä½`, 'success');
                updateProgress(20);
            }

            // 3. æå–é¡è‰²
            if (document.getElementById('extractColor').checked) {
                addLog('â³ åŸ·è¡Œ: æå–é¡è‰²å±¬æ€§...', 'info');
                if (!headers.includes('æå–_é¡è‰²_ä¸­æ–‡')) headers.push('æå–_é¡è‰²_ä¸­æ–‡');
                if (!headers.includes('æå–_é¡è‰²_è‹±æ–‡')) headers.push('æå–_é¡è‰²_è‹±æ–‡');
                
                cleanedData.forEach(row => {
                    const chineseName = row['Chinese Web Item Name'] || '';
                    const chineseMatch = chineseName.match(/\[([^\]]+)\]/);
                    row['æå–_é¡è‰²_ä¸­æ–‡'] = chineseMatch ? chineseMatch[1] : '';
                    
                    const englishName = row['English Web Item Name'] || '';
                    const englishMatch = englishName.match(/\[([^\]]+)\]/);
                    row['æå–_é¡è‰²_è‹±æ–‡'] = englishMatch ? englishMatch[1] : '';
                    
                    if (chineseMatch || englishMatch) stats.colorExtracted++;
                });
                addLog(`âœ“ æˆåŠŸæå– ${stats.colorExtracted} æ¢é¡è‰²ä¿¡æ¯`, 'success');
                updateProgress(30);
            }

            // 4. æå–å°ºå¯¸
            if (document.getElementById('extractSize').checked) {
                addLog('â³ åŸ·è¡Œ: æå–å°ºå¯¸è¦æ ¼...', 'info');
                if (!headers.includes('æå–_å°ºå¯¸_ä¸­æ–‡')) headers.push('æå–_å°ºå¯¸_ä¸­æ–‡');
                if (!headers.includes('æå–_å°ºå¯¸_è‹±æ–‡')) headers.push('æå–_å°ºå¯¸_è‹±æ–‡');
                
                cleanedData.forEach(row => {
                    const chSize = row['Chinese Web Item Name'] || '';
                    const chSizeMatches = [];
                    const patterns = [
                        /\d+\.?\d*\s*x\s*\d+\.?\d*\s*(æ¯«ç±³|å˜ç±³|å‹|å°º|mm|cm|in|ft)/gi,
                        /\d+\.?\d*\s*(æ¯«ç±³|å˜ç±³|å‹|å°º|mm|cm|in|ft|å…‹|g|ml|æ¯«å‡)/gi
                    ];
                    patterns.forEach(pattern => {
                        const matches = chSize.match(pattern);
                        if (matches) chSizeMatches.push(...matches);
                    });
                    row['æå–_å°ºå¯¸_ä¸­æ–‡'] = chSizeMatches.join(' ');
                    
                    const enSize = row['English Web Item Name'] || '';
                    const enSizeMatches = [];
                    const enPatterns = [
                        /\d+\.?\d*\s*x\s*\d+\.?\d*\s*(mm|cm|in|ft|m)/gi,
                        /\d+\.?\d*\s*(mm|cm|in|ft|m|g|ml|l)/gi
                    ];
                    enPatterns.forEach(pattern => {
                        const matches = enSize.match(pattern);
                        if (matches) enSizeMatches.push(...matches);
                    });
                    row['æå–_å°ºå¯¸_è‹±æ–‡'] = enSizeMatches.join(' ');
                    
                    if (chSizeMatches.length > 0 || enSizeMatches.length > 0) stats.sizeExtracted++;
                });
                addLog(`âœ“ æˆåŠŸæå– ${stats.sizeExtracted} æ¢å°ºå¯¸ä¿¡æ¯`, 'success');
                updateProgress(40);
            }

            // 5. æå–æ•¸é‡
            if (document.getElementById('extractQuantity').checked) {
                addLog('â³ åŸ·è¡Œ: æå–æ•¸é‡åŒ…è£...', 'info');
                if (!headers.includes('æå–_æ•¸é‡_ä¸­æ–‡')) headers.push('æå–_æ•¸é‡_ä¸­æ–‡');
                if (!headers.includes('æå–_æ•¸é‡_è‹±æ–‡')) headers.push('æå–_æ•¸é‡_è‹±æ–‡');
                
                cleanedData.forEach(row => {
                    const chQty = row['Chinese Web Item Name'] || '';
                    const chQtyMatch = chQty.match(/\d+\s*(æšè£|å€‹è£|ä»¶è£|æ”¯è£|æ¢è£|å·è£|æœ¬è£|å¼µè£|ç²’è£|é )/gi);
                    row['æå–_æ•¸é‡_ä¸­æ–‡'] = chQtyMatch ? chQtyMatch.join(' ') : '';
                    
                    const enQty = row['English Web Item Name'] || '';
                    const enQtyMatch = enQty.match(/\d+\s*s\b/gi);
                    row['æå–_æ•¸é‡_è‹±æ–‡'] = enQtyMatch ? enQtyMatch.join(' ') : '';
                    
                    if (chQtyMatch || enQtyMatch) stats.quantityExtracted++;
                });
                addLog(`âœ“ æˆåŠŸæå– ${stats.quantityExtracted} æ¢æ•¸é‡ä¿¡æ¯`, 'success');
                updateProgress(50);
            }

            // 6. æ‹†åˆ†ç”¢å“åç¨±
            if (document.getElementById('splitNames').checked) {
                addLog('â³ åŸ·è¡Œ: æ‹†åˆ†ç”¢å“åç¨±...', 'info');
                
                const newColumns = [
                    'ä¸­æ–‡ç”¢å“åŸºç¤åç¨±',
                    'ä¸­æ–‡å±¬æ€§è®Šé‡',
                    'English Product Base Name',
                    'English Attributes'
                ];
                
                newColumns.forEach(col => {
                    if (!headers.includes(col)) headers.push(col);
                });

                // æœ¬æ©Ÿæ¨¡å¼æ‹†åˆ†
                cleanedData.forEach(row => {
                    const chineseName = row['Chinese Web Item Name'] || '';
                    const chineseBaseName = extractChineseBaseName(chineseName);
                    const chineseAttributes = extractAttributes(chineseName, chineseBaseName);
                    
                    row['ä¸­æ–‡ç”¢å“åŸºç¤åç¨±'] = chineseBaseName;
                    row['ä¸­æ–‡å±¬æ€§è®Šé‡'] = chineseAttributes;
                    
                    const englishName = row['English Web Item Name'] || '';
                    const englishBaseName = extractEnglishBaseName(englishName);
                    const englishAttributes = extractAttributes(englishName, englishBaseName);
                    
                    row['English Product Base Name'] = englishBaseName;
                    row['English Attributes'] = englishAttributes;
                    
                    if (chineseBaseName || englishBaseName) stats.namesSplit++;
                });
                
                addLog(`âœ“ æœ¬æ©Ÿè¦å‰‡æ‹†åˆ†å®Œæˆ: ${stats.namesSplit} æ¢`, 'success');
                updateProgress(60);

                // AIæ¨¡å¼: æ‰¹æ¬¡é©—è­‰å’Œä¿®æ­£
                if (currentMode === 'ai') {
                    addLog('ğŸ¤– é–‹å§‹AIæ™ºèƒ½é©—è­‰...', 'ai');
                    const batchSize = parseInt(batchSizeInput.value) || 10;
                    const totalBatches = Math.ceil(cleanedData.length / batchSize);
                    
                    for (let i = 0; i < totalBatches; i++) {
                        const start = i * batchSize;
                        const end = Math.min(start + batchSize, cleanedData.length);
                        const batch = cleanedData.slice(start, end).map(row => ({
                            chinese_original: row['Chinese Web Item Name'],
                            chinese_base: row['ä¸­æ–‡ç”¢å“åŸºç¤åç¨±'],
                            chinese_attrs: row['ä¸­æ–‡å±¬æ€§è®Šé‡'],
                            english_original: row['English Web Item Name'],
                            english_base: row['English Product Base Name'],
                            english_attrs: row['English Attributes']
                        }));

                        addLog(`ğŸ”„ AIé©—è­‰æ‰¹æ¬¡ ${i + 1}/${totalBatches} (${start + 1}-${end}è¡Œ)...`, 'ai');
                        
                        const results = await aiVerifyAndCorrect(batch);
                        
                        if (results) {
                            results.forEach((result, idx) => {
                                const rowIndex = start + idx;
                                if (result.corrected) {
                                    cleanedData[rowIndex]['ä¸­æ–‡ç”¢å“åŸºç¤åç¨±'] = result.chinese_base;
                                    cleanedData[rowIndex]['ä¸­æ–‡å±¬æ€§è®Šé‡'] = result.chinese_attrs;
                                    cleanedData[rowIndex]['English Product Base Name'] = result.english_base;
                                    cleanedData[rowIndex]['English Attributes'] = result.english_attrs;
                                    stats.aiCorrected++;
                                }
                                stats.aiVerified++;
                            });
                            addLog(`âœ“ æ‰¹æ¬¡ ${i + 1} å®Œæˆ, ä¿®æ­£äº† ${results.filter(r => r.corrected).length} æ¢`, 'success');
                        } else {
                            addLog(`âš  æ‰¹æ¬¡ ${i + 1} é©—è­‰å¤±æ•—,ä¿æŒåŸçµæœ`, 'warning');
                        }

                        const progress = 60 + (i + 1) / totalBatches * 30;
                        updateProgress(progress);
                        
                        // é¿å…API rate limit
                        await new Promise(resolve => setTimeout(resolve, 500));
                    }
                    
                    addLog(`ğŸ¯ AIé©—è­‰å®Œæˆ! ç¸½å…±é©—è­‰ ${stats.aiVerified} æ¢, ä¿®æ­£ ${stats.aiCorrected} æ¢`, 'ai');
                }
            }

            // å®Œæˆ
            updateProgress(100);
            addLog('ğŸ‰ æ•¸æ“šæ¸…æ´—å®Œæˆ!', 'success');
            
            displayStats(stats);
            displayPreview();
            
            startCleanBtn.disabled = false;
            startCleanBtn.textContent = 'ğŸš€ é–‹å§‹æ¸…æ´—æ•¸æ“š';
            
            setTimeout(() => {
                previewSection.scrollIntoView({ behavior: 'smooth' });
            }, 300);
        });

        // é¡¯ç¤ºçµ±è¨ˆä¿¡æ¯
        function displayStats(stats) {
            document.getElementById('totalRows').textContent = stats.total.toLocaleString();
            document.getElementById('cleanedRows').textContent = cleanedData.length.toLocaleString();
            document.getElementById('duplicateCount').textContent = stats.duplicates.toLocaleString();
            document.getElementById('aiVerified').textContent = (currentMode === 'ai' ? stats.aiVerified : cleanedData.length).toLocaleString();
            document.getElementById('colorExtracted').textContent = stats.colorExtracted.toLocaleString();
            document.getElementById('sizeExtracted').textContent = stats.sizeExtracted.toLocaleString();
            
            if (currentMode === 'ai' && stats.aiCorrected > 0) {
                addLog(`ğŸ“Š AIä¿®æ­£çµ±è¨ˆ: ${stats.aiCorrected}æ¢æ•¸æ“šè¢«æ™ºèƒ½ä¿®æ­£`, 'ai');
            }
            
            statsSection.style.display = 'block';
        }

        // é¡¯ç¤ºé è¦½
        function displayPreview() {
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            
            tableHead.innerHTML = '';
            tableBody.innerHTML = '';
            
            const headerRow = document.createElement('tr');
            headers.forEach(header => {
                const th = document.createElement('th');
                th.textContent = header;
                headerRow.appendChild(th);
            });
            tableHead.appendChild(headerRow);
            
            const previewData = cleanedData.slice(0, 50);
            previewData.forEach((row, index) => {
                const tr = document.createElement('tr');
                headers.forEach(header => {
                    const td = document.createElement('td');
                    td.textContent = row[header] || '';
                    if (header.includes('åŸºç¤åç¨±') || header.includes('Base Name') || 
                        header.includes('å±¬æ€§è®Šé‡') || header.includes('Attributes')) {
                        td.style.backgroundColor = '#fff3cd';
                        td.style.fontWeight = 'bold';
                    }
                    tr.appendChild(td);
                });
                tableBody.appendChild(tr);
            });
            
            previewSection.style.display = 'block';
        }

        // ä¸‹è¼‰æ¸…æ´—å¾Œçš„CSV
        downloadBtn.addEventListener('click', () => {
            addLog('â³ æº–å‚™ä¸‹è¼‰æ–‡ä»¶...', 'info');
            
            const csv = Papa.unparse({
                fields: headers,
                data: cleanedData
            });
            
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            const modePrefix = currentMode === 'ai' ? 'ai_enhanced' : 'local';
            link.setAttribute('href', url);
            link.setAttribute('download', `cleaned_data_${modePrefix}_${new Date().getTime()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            addLog('âœ“ æ–‡ä»¶ä¸‹è¼‰æˆåŠŸ!', 'success');
        });
    </script>
</body>
</html>